<!DOCTYPE html>
<html>
<head>
    <title>Stock / Index App</title>
    <style>
        body { margin:0; font-family: Arial, sans-serif; background:#f5f5f5; }
        .top-bar {
            display: flex; align-items: center; background:#222; padding:4px 6px; color:white; gap:4px; flex-wrap:wrap;
        }
        .top-bar input, .top-bar select, .top-bar button {
            height:28px; padding:4px 8px; border-radius:4px; border:none; font-size:12px; cursor:pointer;
        }
        .active { background:#00aaff; color:white; }
        #backendDiv, #frontendDiv {
            padding:10px; background:#fff; margin:6px; border-radius:6px; 
            box-shadow:0 0 6px rgba(0,0,0,0.1); max-height:calc(100vh - 60px); overflow-y:auto;
        }
        table { border-collapse:collapse; width:100%; margin:6px 0; font-size:12px; }
        table, th, td { border:1px solid #aaa; }
        th { background:#00aaff; color:white; padding:4px; }
        td { padding:4px; }
        #statusBox {
            margin-left:auto; font-size:12px; background:#444; padding:2px 6px;
            border-radius:4px; color:#fff; max-width:400px; overflow-x:auto; white-space:nowrap;
        }
    </style>
</head>
<body>

<div class="top-bar">
    <button id="btnStock" class="active" onclick="setMode('stock')">Stock</button>
    <button id="btnIndex" onclick="setMode('index')">Index</button>

    <input id="symbolInput" type="text" value="ITC" style="width:80px;">
    <select id="reqType" style="width:120px"></select>
    <input id="dateInput" type="date" style="width:110px;">
    <button id="fetchBtn" onclick="fetchNow()" style="background:#2196f3;color:white;">Fetch</button>

    <select id="sourceType" style="width:100px" onchange="updateBackendURL()">
        <option value="colab">Colab</option>
        <option value="hf">HF</option>
    </select>
    <input id="backendURL" type="text" placeholder="Backend URL" style="width:250px;">

    <button id="btnBackend" class="active" onclick="setSide('backend')">Backend</button>
    <button id="btnFrontend" onclick="setSide('frontend')">Frontend</button>

    <div id="statusBox">stock,info,ITC | Colab | </div>
</div>

<div id="backendDiv"><h3>Backend Output</h3></div>
<div id="frontendDiv"><h3>Frontend Extracted Tables</h3><p>No tables yet.</p></div>

<script type="module">
import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/dist/index.min.js";

let currentMode = "stock";
let currentSide = "backend";
let appClient = null;
let currentClientSource = null;

const reqOptions = {
    stock: [ 
        "info", "intraday", "daily","nse_eq", "qresult", "result", "balance",
        "cashflow", "dividend", "split", "other","stock_hist"
    ],
    index: [ 
        "indices", "nse_open", "nse_preopen", "nse_fno","nse_fiidii","nse_events",
        "nse_future", "nse_bhav", "nse_highlow","index_history","nse_largedeals",
        "nse_most_active","largedeals_historical","nse_bulkdeals",
        "nse_blockdeals","index_pe_pb_div","index_total_returns"
    ]
};

// ---------------- DEFAULT DATE ----------------
function setDefaultDate(){
    const d = new Date();
    d.setDate(d.getDate() - 1);   // yesterday
    document.getElementById("dateInput").value = d.toISOString().split("T")[0];
}
setDefaultDate();

// ---------------- POPULATE DROPDOWN ----------------
function populateReqType(){
    const dropdown = document.getElementById("reqType");
    dropdown.innerHTML = reqOptions[currentMode]
        .map(x => `<option value="${x}">${x}</option>`)
        .join('');
}
populateReqType();

// ---------------- BACKEND URL CONTROL ----------------
function updateBackendURL() {
    const src = document.getElementById("sourceType").value;
    const input = document.getElementById("backendURL");

    appClient = null;
    currentClientSource = null;

    if(src === "hf"){
        input.value = "eshan6704/backend";
        input.disabled = true;
    } else {
        input.value = "";
        input.disabled = false;
    }
}

// ---------------- CONNECT CLIENT ----------------
async function connectClient(){
    const src = document.getElementById("sourceType").value;

    if(src === "colab"){
        const url = document.getElementById("backendURL").value.trim();
        if(!url) return null;

        if(appClient && currentClientSource === "colab") return appClient;

        try {
            appClient = await Client.connect(url);
            currentClientSource = "colab";
            return appClient;
        } catch(e){
            appClient = null;
            return null;
        }
    }

    if(src === "hf"){
        const url = "eshan6704/backend";
        if(appClient && currentClientSource === "hf") return appClient;

        try {
            appClient = await Client.connect(url);
            currentClientSource = "hf";
            return appClient;
        } catch(e){
            appClient = null;
            return null;
        }
    }

    return null;
}

// ---------------- STATUS UPDATE ----------------
function updateStatus(req_type, symbol, date){
    const src = document.getElementById("sourceType").value;
    const url = (src==="hf")?"eshan6704/backend":document.getElementById("backendURL").value.trim();
    const srcLabel = (src==="colab")?"Colab":"Hugging Face";
    document.getElementById("statusBox").innerText = `${currentMode},${req_type},${symbol},${date} | ${srcLabel} | ${url}`;
}

// ---------------- FETCH BACKEND ----------------
async function fetchFromBackend(mode, req_type, name, date){
    if(!appClient) await connectClient();
    if(!appClient) return ["<p style='color:red;'>Unable to connect to backend</p>"];

    const src = document.getElementById("sourceType").value;

    try{
        let result;
        if(src === "hf"){
            result = await appClient.predict("/fetch_data",[mode, req_type, name, date]);
        } else {
            result = await appClient.predict("/fetch_data",{mode, req_type, name, date_str:date});
        }

        if(!result || !result.data) return ["<p>No data returned</p>"];

        if(Array.isArray(result.data[0])) return result.data[0];
        if(typeof result.data[0] === "string") return [result.data[0]];
        return ["<p>Unexpected data format</p>"];

    } catch(err){
        return [`<p style='color:red;'>Backend error: ${err.message}</p>`];
    }
}

// ---------------- FETCH BUTTON ----------------
window.fetchNow = async function(){
    const name = document.getElementById("symbolInput").value;
    const req_type = document.getElementById("reqType").value;
    const rawDate = document.getElementById("dateInput").value;
    const date = rawDate.split("-").reverse().join("-");

    updateStatus(req_type, name, date);

    const backendDiv = document.getElementById("backendDiv");
    const frontendDiv = document.getElementById("frontendDiv");
    backendDiv.innerHTML = "<h3>Backend Output</h3>";
    frontendDiv.innerHTML = "<h3>Frontend Extracted Tables</h3>";

    const blocks = await fetchFromBackend(currentMode, req_type, name, date);

    const fragBackend = document.createDocumentFragment();
    const fragTables = document.createDocumentFragment();

    blocks.forEach(block=>{
        const div = document.createElement("div");
        div.innerHTML = block;
        fragBackend.appendChild(div);
        fragBackend.appendChild(document.createElement("hr"));

        const temp = document.createElement("div");
        temp.innerHTML = block;
        temp.querySelectorAll("table").forEach(tbl=>{
            fragTables.appendChild(tbl.cloneNode(true));
            fragTables.appendChild(document.createElement("hr"));
        });
    });

    backendDiv.appendChild(fragBackend);
    frontendDiv.appendChild(fragTables);

    if(!frontendDiv.querySelector("table"))
        frontendDiv.innerHTML += "<p>No tables found.</p>";

    updateSideDisplay();
};

// ---------------- MODE SWITCH ----------------
window.setMode = function(mode){
    currentMode = mode;

    document.getElementById("btnStock").classList.toggle("active", mode==="stock");
    document.getElementById("btnIndex").classList.toggle("active", mode==="index");

    populateReqType();

    if(mode === "index"){
        document.getElementById("symbolInput").value = "NIFTY 50";
    }

    document.getElementById("backendDiv").innerHTML="<h3>Backend Output</h3>";
    document.getElementById("frontendDiv").innerHTML="<h3>Frontend Extracted Tables</h3><p>No tables yet.</p>";
};

// ---------------- VIEW SWITCH ----------------
window.setSide = function(side){
    currentSide = side;
    updateSideDisplay();
};

function updateSideDisplay(){
    document.getElementById("btnBackend").classList.toggle("active", currentSide==="backend");
    document.getElementById("btnFrontend").classList.toggle("active", currentSide==="frontend");
    document.getElementById("backendDiv").style.display = (currentSide==="backend")?"block":"none";
    document.getElementById("frontendDiv").style.display = (currentSide==="frontend")?"block":"none";
}

document.getElementById("symbolInput").addEventListener("keypress", e=>{
    if(e.key==="Enter") fetchNow();
});

setMode("stock");
updateSideDisplay();
</script>
</body>
</html>
